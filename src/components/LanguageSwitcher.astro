---
import { languages, type Lang } from "../lib/i18n";

const DEFAULT_LANG: Lang = "da";
const supported = languages as readonly string[];

// Vi bytter fil-stien ud med emojis
const flagEmoji = (l: string) => {
  if (l === "da") return "üá©üá∞";
  if (l === "en") return "üá¨üáß";
  if (l === "es") return "üá™üá∏";
  return "üåê";
};

const flagLabel = (l: string) =>
  l === "da" ? "Dansk" : l === "en" ? "English" : "Espa√±ol";
---

<div
  id="lang-switcher"
  class="language-switcher flags-switcher"
  data-default-lang={DEFAULT_LANG}
>
  {supported.map((l) => (
    <a
      href={`/${l}`}
      data-lang={l}
      aria-label={flagLabel(l)}
      lang={l}
      style="background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; margin: 0 6px;"
    >
      <span class="flag" style="font-size: 24px; line-height: 1; transition: transform 0.2s ease;">
        {flagEmoji(l)}
      </span>
    </a>
  ))}
</div>

<script is:inline>
(() => {
  const root = document.getElementById("lang-switcher");
  if (!root) return;

  const defaultLang = root.getAttribute("data-default-lang") || "da";
  const links = Array.from(root.querySelectorAll("a[data-lang]"));

  const rawPath = window.location.pathname || "/";
  const pathname =
    rawPath !== "/" && rawPath.endsWith("/")
      ? rawPath.slice(0, -1)
      : rawPath;

  const segments = pathname.split("/").filter(Boolean);
  const first = segments[0];

  const supported = links
    .map((a) => a.getAttribute("data-lang"))
    .filter(Boolean);

  const hasLangPrefix = supported.includes(first);

  const rest = hasLangPrefix
    ? pathname.replace(new RegExp(`^/(${supported.join("|")})(?=/|$)`), "")
    : pathname;

  const currentLang = hasLangPrefix ? first : defaultLang;

  links.forEach((a) => {
    const l = a.getAttribute("data-lang");
    if (!l) return;

    const tail = rest === "/" ? "" : rest;
    a.setAttribute("href", `/${l}${tail}`);

    if (l === currentLang) {
      a.classList.add("active");
      a.setAttribute("aria-current", "true");
      // G√∏r det aktive flag en smule st√∏rre
      a.style.opacity = "1";
      a.style.transform = "scale(1.15)";
    } else {
      a.classList.remove("active");
      a.removeAttribute("aria-current");
      // D√¶mp de inaktive flag en smule
      a.style.opacity = "0.5";
      a.style.transform = "scale(1)";
    }
  });
})();
</script>