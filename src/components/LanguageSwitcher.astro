---
import { languages, type Lang } from "../lib/i18n";

const DEFAULT_LANG: Lang = "da";
const supported = languages as readonly string[];
const supportedPattern = supported.join("|");
---

<div id="lang-switcher" class="language-switcher" data-default-lang={DEFAULT_LANG} data-supported={supportedPattern}>
  {supported.map((l, index) => (
    <>
      <a href={`/${l}`} data-lang={l}>
        {l.toUpperCase()}
      </a>
      {index < supported.length - 1 && <span> / </span>}
    </>
  ))}
</div>

<script is:inline>
(() => {
  const root = document.getElementById("lang-switcher");
  if (!root) return;

  const supportedPattern = root.getAttribute("data-supported") || "da|en|es";
  const defaultLang = root.getAttribute("data-default-lang") || "da";

  const links = Array.from(root.querySelectorAll('a[data-lang]'));
  const supported = links.map(a => a.getAttribute("data-lang")).filter(Boolean);

  // Path real del navegador
  const raw = window.location.pathname || "/";
  const pathname = (raw !== "/" && raw.endsWith("/")) ? raw.slice(0, -1) : raw;

  const first = pathname.split("/")[1] || "";
  const hasPrefix = supported.includes(first);

  // Resto de ruta sin el /{lang}
  const rest = hasPrefix
    ? pathname.replace(new RegExp(`^/(${supportedPattern})(?=/|$)`), "")
    : pathname;

  const currentLang = hasPrefix ? first : defaultLang;

  links.forEach((a) => {
    const l = a.getAttribute("data-lang");
    if (!l) return;

    const tail = (rest === "/" ? "" : rest); // si rest es "/", es home
    a.setAttribute("href", `/${l}${tail}`);

    if (l === currentLang) a.setAttribute("aria-current", "page");
    else a.removeAttribute("aria-current");
  });
})();
</script>
