---
import { languages, type Lang } from "../lib/i18n";

const DEFAULT_LANG: Lang = "da";
const supported = languages as readonly string[];

const flagSrc = (l: string) => `/images/flags/${l}.svg`;
const flagLabel = (l: string) =>
  l === "da" ? "Dansk" : l === "en" ? "English" : "Espa√±ol";
---

<div
  id="lang-switcher"
  class="language-switcher flags-switcher"
  data-default-lang={DEFAULT_LANG}
>
  {supported.map((l) => (
    <a
      class="flag-link"
      href={`/${l}`}
      data-lang={l}
      aria-label={flagLabel(l)}
      lang={l}
    >
      <img
        class="flag"
        src={flagSrc(l)}
        alt={flagLabel(l)}
        width="28"
        height="20"
        loading="lazy"
      />
    </a>
  ))}
</div>

<script is:inline>
(() => {
  const root = document.getElementById("lang-switcher");
  if (!root) return;

  const defaultLang = root.getAttribute("data-default-lang") || "da";
  const links = Array.from(root.querySelectorAll("a[data-lang]"));

  const rawPath = window.location.pathname || "/";
  const pathname =
    rawPath !== "/" && rawPath.endsWith("/")
      ? rawPath.slice(0, -1)
      : rawPath;

  const segments = pathname.split("/").filter(Boolean);
  const first = segments[0];

  const supported = links
    .map((a) => a.getAttribute("data-lang"))
    .filter(Boolean);

  const hasLangPrefix = supported.includes(first);

  const rest = hasLangPrefix
    ? pathname.replace(new RegExp(`^/(${supported.join("|")})(?=/|$)`), "")
    : pathname;

  const currentLang = hasLangPrefix ? first : defaultLang;

  links.forEach((a) => {
    const l = a.getAttribute("data-lang");
    if (!l) return;

    const tail = rest === "/" ? "" : rest;
    a.setAttribute("href", `/${l}${tail}`);

    if (l === currentLang) {
      a.classList.add("active");
      a.setAttribute("aria-current", "true");
    } else {
      a.classList.remove("active");
      a.removeAttribute("aria-current");
    }
  });
})();
</script>