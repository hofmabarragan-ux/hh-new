---
const { title, text, placeholder, button } = Astro.props;
---

<section class="newsletter-section" aria-label="Newsletter">
  <div class="container">
    <div class="newsletter-inner">
      <h2>{title}</h2>
      <p>{text}</p>

      <form class="newsletter-form" id="newsletter-form">
        <label class="sr-only" for="newsletter-email">
          Email
        </label>

        <input
          id="newsletter-email"
          name="email"
          type="email"
          placeholder={placeholder}
          autocomplete="email"
          inputmode="email"
          required
          aria-label={placeholder ?? "Email"}
        />

        <div class="newsletter-actions">
          <button class="button-primary" type="submit" id="newsletter-submit-btn">
            {button}
          </button>
          <span class="newsletter-status" id="newsletter-status" aria-live="polite"></span>
        </div>
      </form>
    </div>
  </div>
</section>

<style>
  .newsletter-section {
    width: 100%;
  }

  .newsletter-inner {
    max-width: 820px;
    margin: 0 auto;
    text-align: center; /* siempre centrado */
  }

  .newsletter-inner p {
    margin: 0.75rem auto 0 auto;
    max-width: 70ch;
  }

  .newsletter-form {
    margin-top: 1.25rem;
    display: flex;
    justify-content: center; /* siempre centrado */
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .newsletter-form input {
    width: min(520px, 100%);
    padding: 0.85rem 0.9rem;
    border-radius: var(--radius);
    border: 1px solid rgba(0, 0, 0, 0.12);
  }

  /* Accesibilidad: label oculto visualmente */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .newsletter-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .newsletter-status {
    font-size: 0.9rem;
  }
  .newsletter-status:not(.error) {
    color: #16a34a;
  }
  .newsletter-status.error {
    color: #dc2626;
  }

  @media (max-width: 520px) {
    .newsletter-form {
      flex-direction: column;
      align-items: center;
    }

    .newsletter-actions {
      flex-direction: column;
    }

    .newsletter-form button {
      width: min(260px, 100%);
    }
  }
</style>

<script define:vars={{ scriptUrl: import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL, sendingText: "Sender...", successText: "Tak! Du er nu tilmeldt.", buttonText: button }}>
  const form = document.getElementById('newsletter-form');
  const btn = document.getElementById('newsletter-submit-btn');
  const statusEl = document.getElementById('newsletter-status');

  if (form && btn && statusEl && scriptUrl) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      btn.textContent = sendingText;
      statusEl.textContent = '';
      statusEl.className = 'newsletter-status';

      const email = form.querySelector('[name="email"]')?.value ?? '';

      try {
        await fetch(scriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ type: 'newsletter', email }),
        });
        statusEl.textContent = successText;
        form.reset();
      } catch (err) {
        statusEl.textContent = 'Der opstod en fejl. Pr√∏v venligst igen.';
        statusEl.className = 'newsletter-status error';
      } finally {
        btn.disabled = false;
        btn.textContent = buttonText;
      }
    });
  }
</script>