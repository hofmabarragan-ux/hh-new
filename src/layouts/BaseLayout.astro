---
import "../styles/global.css";
import { getContent, languages, type Lang } from "../lib/i18n";
import { SITE, CONTACT } from "../config/site";

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const { lang = "da", seo } = Astro.props as { lang?: Lang; seo?: any };
const content = getContent(lang);
if (!content) throw new Error(`Idioma no soportado: ${lang}`);

/* origin consistente + normalizado (sin trailing slash) */
const originRaw = import.meta.env.DEV
  ? Astro.url.origin
  : (Astro.site?.origin ?? SITE.origin ?? "https://hofmahomes.com");

const origin = String(originRaw).replace(/\/+$/, "");

/* Helpers: normalizar links (defensivo) */
const toMailto = (v: string) => {
  if (!v) return "";
  if (v.startsWith("mailto:")) return v;
  if (v.startsWith("http://") || v.startsWith("https://")) return v;
  return v.includes("@") ? `mailto:${v}` : v;
};

const toTel = (v: string) => {
  if (!v) return "";
  if (v.startsWith("tel:")) return v;
  if (v.startsWith("http://") || v.startsWith("https://")) return v;
  return `tel:${v}`;
};

const toWhatsApp = (v: string) => {
  if (!v) return "";
  if (v.startsWith("http://") || v.startsWith("https://")) return v;
  const digits = v.replace(/\D/g, "");
  return digits ? `https://wa.me/${digits}` : v;
};

/* CONTACT (defensivo) */
const emailUrl = toMailto((CONTACT as any)?.email ?? "");
const phoneUrl = toTel((CONTACT as any)?.phone ?? "");
const whatsappUrl = toWhatsApp((CONTACT as any)?.whatsapp ?? "");
const calendlyUrl = (CONTACT as any)?.calendlyUrl ?? (CONTACT as any)?.calendly ?? "#";

/* REDES (ideal: mover a config más adelante) */
const social = {
  facebook: "https://facebook.com/",
  instagram: "https://instagram.com/",
  tiktok: "https://tiktok.com/",
  youtube: "https://youtube.com/",
  linkedin: "https://linkedin.com/",
};

const title = seo?.title ?? "HOFMA Homes";
const description = seo?.description ?? "Real estate investment in Spain with a Nordic approach.";

/* Path sin prefijo de idioma para construir alternates correctos (dinámico) */
const langsRe = new RegExp(`^/(${languages.join("|")})(?=/|$)`, "i");
const pathWithoutLang = Astro.url.pathname.replace(langsRe, "");

/* Canonical robusto */
const canonical = String(seo?.canonical ?? `${origin}${Astro.url.pathname}`).replace(/([^:]\/)\/+/g, "$1");

/* OG */
const siteName = (SITE as any)?.name ?? "HOFMA Homes";
const ogTitle = seo?.og?.title ?? title;
const ogDescription = seo?.og?.description ?? description;
const ogImage = seo?.og?.image ?? `${origin}/images/hero.jpg`;
const ogLocale = seo?.og?.locale;

/* hreflang */
const hreflangs =
  (seo?.hreflangs as Array<{ lang: string; url: string }> | undefined) ??
  languages.map((l) => ({ lang: l, url: `${origin}/${l}${pathWithoutLang || ""}` }));

const xDefaultHref = `${origin}/da${pathWithoutLang || ""}`;

/* Active state nav */
const pathname = Astro.url.pathname;
const isActive = (path: string) => {
  const base = `/${lang}${path}`;
  return pathname === base || pathname.startsWith(`${base}/`);
};

/* Nav labels fallbacks (defensivo) */
const navServices =
  content?.nav?.services ?? (lang === "es" ? "Servicios" : lang === "da" ? "Services" : "Services");

const navInvestment =
  content?.nav?.investment ?? (lang === "es" ? "Inversión" : lang === "da" ? "Investering" : "Investment");

const navProjects =
  content?.nav?.projects ?? (lang === "es" ? "Proyectos" : lang === "da" ? "Projekter" : "Projects");

const navAbout = content?.nav?.about ?? (lang === "es" ? "Sobre nosotros" : lang === "da" ? "Om os" : "About");
const navBlog = content?.nav?.blog ?? "Blog";

const navTerms = content?.nav?.terms ?? (lang === "es" ? "Términos" : lang === "da" ? "Vilkår" : "Terms");

const navCookie =
  content?.nav?.cookie ??
  (lang === "es" ? "Cookies y privacidad" : lang === "da" ? "Cookies og privatliv" : "Cookies & privacy");

const navEmail = content?.nav?.email ?? "Email";
const navCall = content?.nav?.call ?? (lang === "es" ? "Llamar" : lang === "da" ? "Ring" : "Call");

const navBookCall =
  content?.nav?.bookCall ?? (lang === "es" ? "Agendar llamada" : lang === "da" ? "Book møde" : "Book a call");

/* Footer labels */
const footerHomeLabel = content?.nav?.home ?? (lang === "es" ? "Inicio" : lang === "da" ? "Hjem" : "Home");

/* Hrefs */
const homeHref = `/${lang}`;
const servicesHref = `/${lang}/services`;
const investmentHref = `/${lang}/investment`;
const projectsHref = `/${lang}/projects`;
const aboutHref = `/${lang}/about`;
const blogHref = `/${lang}/blog`;
const termsHref = `/${lang}/terms`;
const cookieHref = `/${lang}/cookie`;

/* Minimal safety: avoid empty phone links */
const hasPhone = Boolean((CONTACT as any)?.phone);
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={ogDescription} />
    {ogImage && <meta property="og:image" content={ogImage} />}
    {ogLocale && <meta property="og:locale" content={ogLocale} />}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ogTitle} />
    <meta name="twitter:description" content={ogDescription} />
    {ogImage && <meta name="twitter:image" content={ogImage} />}

    {hreflangs.map((alt) => (
      <link rel="alternate" hreflang={alt.lang} href={alt.url} />
    ))}
    <link rel="alternate" hreflang="x-default" href={xDefaultHref} />

    <!-- Make in-page anchor offsets more reliable across browsers (esp. mobile) -->
    <style>
      html {
        scroll-padding-top: var(--header-offset, 170px);
      }
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      main.main-content {
        flex: 1;
      }
      footer.site-footer {
        position: relative;
        z-index: 1;
      }
    </style>
  </head>

  <body>
    <Header
      lang={lang}
      homeHref={homeHref}
      servicesHref={servicesHref}
      investmentHref={investmentHref}
      projectsHref={projectsHref}
      aboutHref={aboutHref}
      blogHref={blogHref}
      navServices={navServices}
      navInvestment={navInvestment}
      navProjects={navProjects}
      navAbout={navAbout}
      navBlog={navBlog}
      navEmail={navEmail}
      navCall={navCall}
      navBookCall={navBookCall}
      emailUrl={emailUrl}
      phoneUrl={phoneUrl}
      whatsappUrl={whatsappUrl}
      calendlyUrl={calendlyUrl}
      social={social}
      hasPhone={hasPhone}
      isActive={isActive}
    />

    <main class="main-content">
      <slot />
    </main>

    <Footer
      lang={lang}
      homeHref={homeHref}
      servicesHref={servicesHref}
      investmentHref={investmentHref}
      projectsHref={projectsHref}
      aboutHref={aboutHref}
      blogHref={blogHref}
      termsHref={termsHref}
      cookieHref={cookieHref}
      footerHomeLabel={footerHomeLabel}
      navServices={navServices}
      navInvestment={navInvestment}
      navProjects={navProjects}
      navAbout={navAbout}
      navBlog={navBlog}
      navTerms={navTerms}
      navCookie={navCookie}
      navEmail={navEmail}
      navCall={navCall}
      navBookCall={navBookCall}
      emailUrl={emailUrl}
      phoneUrl={phoneUrl}
      whatsappUrl={whatsappUrl}
      calendlyUrl={calendlyUrl}
      social={social}
      hasPhone={hasPhone}
    />
  </body>
</html>