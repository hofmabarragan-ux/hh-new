---
import Layout from "../../../layouts/BaseLayout.astro";
import PageHero from "../../../components/PageHero.astro";
import CTA from "../../../components/CTA.astro";
import ContactForm from "../../../components/ContactForm.astro";

import { languages, getContent, type Lang } from "../../../lib/i18n";
import { CONTACT } from "../../../config/site";

type ProjectItem = {
  slug?: string;
  key?: string; // optional shared key across languages (if you add it later)
  title?: string;
  text?: string;
  location?: string;
  seo?: { title?: string; description?: string };
};

/* REQUIRED for dynamic route */
export async function getStaticPaths() {
  const paths: { params: { lang: string; slug: string } }[] = [];

  for (const lang of languages) {
    const content: any = getContent(lang as Lang);
    const list: ProjectItem[] = content?.projects?.items ?? [];

    for (const project of list) {
      if (!project?.slug) continue;
      paths.push({ params: { lang, slug: String(project.slug) } });
    }
  }

  return paths;
}

const { lang, slug } = Astro.params as { lang: Lang; slug: string };
const content: any = getContent(lang);

if (!content) throw new Error(`Idioma no soportado: ${lang}`);

const list: ProjectItem[] = content?.projects?.items ?? [];
const project = list.find((p) => String(p?.slug) === String(slug)) ?? null;

if (!project) throw new Error(`Proyecto no encontrado: ${lang}/${slug}`);

/* Labels */
const backLabel = lang === "es" ? "Volver al catálogo" : lang === "da" ? "Tilbage til katalog" : "Back to catalogue";

/* Links centralizados (defensivo) */
const calendlyUrl = CONTACT?.calendlyUrl ?? CONTACT?.calendly ?? "#";
const hasCalendly = typeof calendlyUrl === "string" && calendlyUrl !== "#";
const calendlyTarget = hasCalendly ? "_blank" : undefined;
const calendlyRel = hasCalendly ? "noopener noreferrer" : undefined;

const phone = CONTACT?.phone ?? "";
const phoneHref = CONTACT?.phoneHref ?? (phone ? `tel:${phone}` : "#");

const whatsapp = CONTACT?.whatsapp ?? "";
const whatsappHref =
  CONTACT?.whatsappHref ?? (whatsapp ? `https://wa.me/${whatsapp.replace(/\D/g, "")}` : "#");

/* Detail CTAs labels (fallbacks) */
const bookCallLabel =
  content?.global?.cta?.bookACall ??
  (lang === "es" ? "Agendar llamada" : lang === "da" ? "Book møde" : "Book a call");

const whatsappLabel = content?.global?.cta?.whatsapp ?? (lang === "es" ? "WhatsApp" : "WhatsApp");

const callLabel = content?.global?.cta?.call ?? (lang === "es" ? "Llamar" : lang === "da" ? "Ring" : "Call");

/* ---------------- SEO ---------------- */
const originRaw = import.meta.env.DEV ? Astro.url.origin : (Astro.site?.origin ?? Astro.url.origin);
const origin = String(originRaw).replace(/\/+$/, "");
const canonical = `${origin}/${lang}/projects/${slug}`;

/**
 * hreflangs:
 * - If the project uses a shared `key`, we assume same slug across languages.
 * - If not, emitting cross-lang hreflangs can be wrong; keep only current language.
 */
const hasSharedKey = Boolean(project?.key);
const hreflangs = hasSharedKey
  ? languages.map((l) => ({ lang: l, url: `${origin}/${l}/projects/${slug}` }))
  : [{ lang, url: canonical }];

const seo = {
  title: project?.seo?.title ?? project?.title ?? "Project",
  description: project?.seo?.description ?? project?.text ?? "",
  canonical,
  hreflangs,
};

/* CONTACT standard (shared across pages) */
const contactTitle = content?.global?.contact?.title ?? "Contact";
const contactSubtitle = content?.global?.contact?.subtitle ?? "Send us a message and we will get back to you shortly.";

/* Contact form labels (optional; fallbacks inside component) */
const formButton = content?.global?.form?.button ?? content?.global?.form?.submit ?? "Send message";
const nameLabel = content?.global?.form?.nameLabel ?? "Name";
const namePlaceholder = content?.global?.form?.namePlaceholder ?? "Name";
const emailLabel = content?.global?.form?.emailLabel ?? "Email";
const emailPlaceholder = content?.global?.form?.emailPlaceholder ?? "Email";
const messageLabel = content?.global?.form?.messageLabel ?? "Message";
const messagePlaceholder = content?.global?.form?.messagePlaceholder ?? "Message";

/* Hero subtitle: avoid repeating project.text (it is rendered below as lead) */
const heroSubtitle = project?.location ? String(project.location) : "";
---

<Layout lang={lang} seo={seo}>
  <!-- HERO (SIN CTAs) -->
  <section class="section blog-top">
    <div class="container">
      <a class="back-link" href={`/${lang}/projects`}>← {backLabel}</a>
    </div>
  </section>

  <PageHero title={project.title} subtitle={heroSubtitle} align="left" size="md" className="project-hero" />

  <main>
    <!-- PROJECT CONTENT -->
    <section class="section section-tight">
      <div class="container">
        {project.text && <p class="lead" style="margin-bottom: 1.25rem;">{project.text}</p>}

        <div class="card">
          <h2 class="h2">
            {lang === "es" ? "Detalles del proyecto" : lang === "da" ? "Projekt-detaljer" : "Project details"}
          </h2>
          <p class="text">
            {lang === "es"
              ? "Más información, números y documentación disponibles bajo solicitud."
              : lang === "da"
                ? "Flere informationer, tal og dokumentation er tilgængelige efter anmodning."
                : "More information, numbers and documentation are available upon request."}
          </p>

          <!-- CTAs (en contenido, no en hero) -->
          <div class="cta-row" style="margin-top: 1rem;">
            <CTA label={bookCallLabel} href="#kontakt" />
            <CTA label={whatsappLabel} href={whatsappHref} />
            <CTA label={callLabel} href={phoneHref} />
          </div>
        </div>
      </div>
    </section>

    <!-- CONTACT (standard + form, shared across pages) -->
    <section id="kontakt" class="section section-contact">
      <div class="container">
        <header class="section-header section-header--center">
          <h2 class="h2">{contactTitle}</h2>
          {contactSubtitle ? <p class="lead">{contactSubtitle}</p> : null}
        </header>

        <div class="contact-form-wrap">
          <ContactForm
            button={formButton}
            nameLabel={nameLabel}
            namePlaceholder={namePlaceholder}
            emailLabel={emailLabel}
            emailPlaceholder={emailPlaceholder}
            messageLabel={messageLabel}
            messagePlaceholder={messagePlaceholder}
          />
        </div>
      </div>
    </section>
  </main>
</Layout>